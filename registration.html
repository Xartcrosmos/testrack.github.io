<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Bike Rack Registration</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    input { padding: 8px; margin: 5px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    #statusMsg { margin-top: 20px; font-weight: bold; }
  </style>
  <script src="https://unpkg.com"></script>
</head>
<body>

  <h1 id="message">Finalizing Lock...</h1>

  <div id="formContainer" style="display:none;">
    <input type="text" id="nameInput" placeholder="Your Name">
    <input type="text" id="contactInput" placeholder="Contact Number">
    <br>
    <button id="submitBtn">Submit</button>
    <div id="statusMsg"></div>
  </div>

  <script>
    window.onload = async function() {
      const SUPABASE_URL = "https://qkswuqrgtbfcdywzuxtk.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrc3d1cXJndGJmY2R5d3p1eHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MjU4MTIsImV4cCI6MjA4MzMwMTgxMn0.OHKaVlA9IpHwlEq5cCm6crJ-n-P-M762MvZqB0XiZxY";
      
      const messageEl = document.getElementById("message");
      const statusMsg = document.getElementById("statusMsg");
      
      if (typeof supabase === 'undefined') {
          messageEl.textContent = "Library Error. Please refresh the page.";
          return;
      }

      const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const params = new URLSearchParams(window.location.search);
      const slot = params.get("slot") ? parseInt(params.get("slot").replace(/\D/g,'')) : null;
      const mySessionId = localStorage.getItem('reg_session_id');

      if (!slot || !mySessionId) {
        window.location.href = "index.html";
        return;
      }

      try {
          const { data: isLocked, error: lockError } = await client.rpc('try_acquire_lock', {
              target_slot: slot,
              new_session_id: mySessionId,
              timeout_seconds: 60
          });

          if (lockError || !isLocked) {
              messageEl.textContent = "Session Expired. Returning home...";
              setTimeout(() => { window.location.href = `index.html?slot=${slot}`; }, 2000);
              return;
          }

          // Cleanup Incomplete Data (Status 0 and 1)
          await client.from('registration').delete().eq('slot', slot).in('status', [0, 1]);

          messageEl.textContent = "Registering for Slot " + slot;
          document.getElementById("formContainer").style.display = "block";

          // Heartbeat
          setInterval(async () => {
            await client.from('web_lock').update({ 
                last_seen: Math.floor(Date.now() / 1000) 
            }).eq('session_id', mySessionId).eq('slot', slot);
          }, 15000);

          // Submit Action
          document.getElementById("submitBtn").onclick = async () => {
            const name = document.getElementById("nameInput").value.trim();
            const contact = document.getElementById("contactInput").value.trim();
            if (!name || !contact) return;
            
            document.getElementById("submitBtn").disabled = true;
            statusMsg.textContent = "Submitting...";

            const { error } = await client.from('registration').insert([
                { slot, name, contact, status: 0 }
            ]);

            if (error) {
                statusMsg.textContent = "Error. Try again.";
                document.getElementById("submitBtn").disabled = false;
            } else {
                statusMsg.textContent = "Waiting for fingerprint...";
                pollStatus(client, slot);
            }
          };

      } catch (err) {
          console.error(err);
          messageEl.textContent = "Connection Error. Check internet.";
      }
    };

    async function pollStatus(client, slot) {
      const statusMsg = document.getElementById("statusMsg");
      
      const { data, error } = await client
        .from('registration')
        .select('*')
        .eq('slot', slot)
        .order('created_at', { ascending: false })
        .limit(1);

      if (error || !data || data.length === 0) {
        setTimeout(() => pollStatus(client, slot), 2000);
        return;
      }

      const record = data[0];

      // ADVANCED SWITCH LOGIC
      switch(record.status) {
        case 0:
          statusMsg.textContent = "Place finger on scanner...";
          setTimeout(() => pollStatus(client, slot), 2000);
          break;
        case 1:
          alert("Fingerprint exists or sensor error. Resetting...");
          // Reset status back to 0 so user can try again
          await client.from('registration').update({ status: 0 }).eq('id', record.id);
          setTimeout(() => pollStatus(client, slot), 2000);
          break;
        case 2:
          statusMsg.textContent = "Scan finger again to confirm...";
          setTimeout(() => pollStatus(client, slot), 2000);
          break;
        case 3:
          statusMsg.textContent = "Registration complete!";
          // Clean up the lock
          await client.from('web_lock').update({ last_seen: 0 }).eq('slot', slot);
          localStorage.removeItem('reg_session_id');
          break;
        default:
          setTimeout(() => pollStatus(client, slot), 2000);
      }
    }
  </script>
</body>
</html>
