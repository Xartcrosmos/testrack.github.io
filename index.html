<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Bike Rack</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
    #registerBtn { padding: 10px 20px; font-size: 18px; cursor: pointer; display: none; }
    .unavailable { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h1 id="message">Validating Slot...</h1>
  <button id="registerBtn">Register</button>

  <script type="module">
    // Direct import from esm.sh to prevent the JSDelivr CORS redirect error
    import { createClient } from "https://esm.sh";

    const SUPABASE_URL = "https://qkswuqrgtbfcdywzuxtk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrc3d1cXJndGJmY2R5d3p1eHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MjU4MTIsImV4cCI6MjA4MzMwMTgxMn0.OHKaVlA9IpHwlEq5cCm6crJ-n-P-M762MvZqB0XiZxY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const slotStr = params.get("slot");
    const slot = slotStr ? parseInt(slotStr.replace(/\D/g,'')) : null;

    const messageEl = document.getElementById("message");
    const buttonEl = document.getElementById("registerBtn");

    // --- SESSION ID PERSISTENCE ---
    let mySessionId = localStorage.getItem('reg_session_id');
    if (!mySessionId) {
        mySessionId = crypto.randomUUID();
        localStorage.setItem('reg_session_id', mySessionId);
    }

    async function handleEntrance() {
      if (!slot) {
        messageEl.textContent = "Welcome to Smart Bike Rack!";
        return;
      }

      console.log("Checking Slot:", slot, "Session:", mySessionId);

      try {
        // 1. Claim the lock via Supabase RPC
        const { data: isLocked, error } = await supabase.rpc('try_acquire_lock', {
            target_slot: slot,
            new_session_id: mySessionId,
            timeout_seconds: 60
        });

        if (error) {
            console.error("Supabase RPC Error:", error.message);
            messageEl.textContent = "Connection Error. Refresh the page.";
            return;
        }

        if (!isLocked) {
          // LOCK FAILED: Slot is busy
          messageEl.textContent = "Slot " + slot + " is UNAVAILABLE";
          messageEl.classList.add("unavailable");
          buttonEl.style.display = "none";
        } else {
          // LOCK SUCCESS: Show button and start heartbeat
          messageEl.textContent = "Slot " + slot + " detected.";
          buttonEl.style.display = "inline-block";
          startHeartbeat();
        }
      } catch (err) {
        console.error("Initialization Failed:", err);
        messageEl.textContent = "Critical Error. Check Console.";
      }
    }

    function startHeartbeat() {
      console.log("Heartbeat active...");
      setInterval(async () => {
        const { error } = await supabase
          .from('web_lock')
          .update({ last_seen: Math.floor(Date.now() / 1000) })
          .eq('session_id', mySessionId)
          .eq('slot', slot);
        
        if (error) console.error("Heartbeat failed:", error.message);
      }, 15000);
    }

    buttonEl.addEventListener("click", () => {
      window.location.href = `registration.html?slot=${slot}`;
    });

    handleEntrance();
  </script>
</body>
</html>
