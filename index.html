<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Bike Rack</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
    #registerBtn { padding: 15px 30px; font-size: 18px; cursor: pointer; display: none; background-color: #2ecc71; color: white; border: none; border-radius: 5px; }
    .unavailable { color: #e74c3c; font-weight: bold; }
    .status-msg { color: #7f8c8d; font-size: 14px; margin-top: 10px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

  <h1 id="message">Validating Slot...</h1>
  <button id="registerBtn">Register Now</button>
  <div id="debugMsg" class="status-msg"></div>

  <script>
    window.onload = async function() {
        if (typeof supabase === 'undefined') {
            document.getElementById("message").textContent = "Library Load Failed";
            return;
        }

        const SUPABASE_URL = "https://qkswuqrgtbfcdywzuxtk.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrc3d1cXJndGJmY2R5d3p1eHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MjU4MTIsImV4cCI6MjA4MzMwMTgxMn0.OHKaVlA9IpHwlEq5cCm6crJ-n-P-M762MvZqB0XiZxY";
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const params = new URLSearchParams(window.location.search);
        const slot = params.get("slot") ? parseInt(params.get("slot").replace(/\D/g,'')) : null;

        const messageEl = document.getElementById("message");
        const buttonEl = document.getElementById("registerBtn");

        // 1. GENERATE SESSION ID (Crucial for the registration page)
        let mySessionId = localStorage.getItem('reg_session_id');
        if (!mySessionId) {
            mySessionId = crypto.randomUUID();
            localStorage.setItem('reg_session_id', mySessionId);
        }

        if (!slot) {
            messageEl.textContent = "Welcome! Please scan a valid QR code.";
            return;
        }

        try {
            // 2. TRY TO ACQUIRE LOCK
            const { data: isLocked, error } = await client.rpc('try_acquire_lock', {
                target_slot: slot,
                new_session_id: mySessionId,
                timeout_seconds: 60
            });

            if (error) throw error;

            if (!isLocked) {
                messageEl.textContent = "Slot " + slot + " is UNAVAILABLE";
                messageEl.classList.add("unavailable");
                document.getElementById("debugMsg").textContent = "Someone else is using this slot. Try again in 1 minute.";
            } else {
                messageEl.textContent = "Slot " + slot + " is Ready!";
                buttonEl.style.display = "inline-block";
                
                // 3. START HEARTBEAT (Keep it locked while they decide to click)
                setInterval(async () => {
                    await client.from('web_lock').update({ 
                        last_seen: Math.floor(Date.now() / 1000) 
                    }).eq('session_id', mySessionId).eq('slot', slot);
                }, 15000);
            }
        } catch (err) {
            console.error(err);
            messageEl.textContent = "Connection Error. Check internet.";
        }

        buttonEl.onclick = () => {
            window.location.href = `registration.html?slot=${slot}`;
        };
    };
  </script>
</body>
</html>
